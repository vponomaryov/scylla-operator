


<!doctype html>
<html class="no-js" lang="en">
  
<head><!-- begin head.html -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
    Deploying Scylla on a Kubernetes Cluster | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server."/>

    <link rel="icon" href="_static/img/favicon.ico" type="image/x-icon"/>
    <link rel="canonical" href="https://docs.scylladb.com/">

    <link rel="author" href="mailto:info@scylladb.com">
    <link rel="stylesheet" href="_static/" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_tabs/tabs.css" />
    
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/css/foundation.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/doc/main.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>

    <script src="_static/js/vendor/modernizr.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T8P2JP');</script>
    <!-- End Google Tag Manager -->

    <!-- Marketo -->
    <script type="text/javascript"> (function() { var didInit = false; function initMunchkin() { if(didInit === false) { didInit = true; Munchkin.init('791-QBF-350'); } } var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//munchkin.marketo.net/munchkin.js'; s.onreadystatechange = function() { if (this.readyState == 'complete' || this.readyState == 'loaded') { initMunchkin(); } }; s.onload = initMunchkin; document.getElementsByTagName('head')[0].appendChild(s); })(); </script>
    <!-- End Marketo -->

<!-- end head.html -->
</head>

<body>



<header id="header" class="animated">
    <div class="topbar_continer contain-to-grid clearfix">
        <nav class="top-bar" id="top-bar" data-topbar role="navigation">
            <ul class="title-area">
                <li class="name">
                    <div class="logo">
                        <a href="https://docs.scylladb.com/"><img src="_static/img/logo-scylla-docs.svg" alt="" width="151"></a>
                    </div>
                </li>
                <li class="toggle-topbar"><a href="#"><span class="icon-manu"></span></a></li>
            </ul>
            <section class="top-bar-section clearfix">
                <ul class="right">
                    
                    <li>
                        <a href="https://scylladb.github.io/scylla-operator/">Scylla Operator</a>
                    </li>
                    
                    <li>
                        <a href="https://docs.scylladb.com/scylla-cloud/">Scylla Cloud</a>
                    </li>
                    
                    <li>
                        <a href="https://university.scylladb.com/">Scylla University</a>
                    </li>
                    
                    <li>
                        <a href="https://www.scylladb.com/">ScyllaDB Home</a>
                    </li>
                    
                    <li class="search_continer show-for-medium-up">	
                        <ci-search></ci-search>	
                    </li>	
                </ul>
            </section>
        </nav>
    </div>
</header>
<section id="content">
    <div class="row">
	
	<div class="large-6 large-push-3 columns">

        

        <div class="section" id="deploying-scylla-on-a-kubernetes-cluster">
<h1>Deploying Scylla on a Kubernetes Cluster<a class="headerlink" href="#deploying-scylla-on-a-kubernetes-cluster" title="Permalink to this headline">¶</a></h1>
<p>This is a guide to deploy a Scylla Cluster in a generic Kubernetes environment, meaning that Scylla will not be deployed with the ideal performance.
Scylla performs the best when it has fast disks and direct access to the cpu.
This requires some extra setup, which is platform-specific.
For specific configuration and setup, check for details about your particular environment:</p>
<ul class="simple">
<li><p><a class="reference internal" href="gke.html"><span class="doc">GKE</span></a></p></li>
</ul>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A Kubernetes cluster (version &gt;= 1.11)</p></li>
<li><p>A <a class="reference external" href="https://kubernetes.io/docs/concepts/storage/storage-classes/">Storage Class</a> to provision <a class="reference external" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">PersistentVolumes</a>.</p></li>
<li><p>Helm 3 installed, Go to the <a class="reference external" href="https://docs.helm.sh/using_helm/#installing-helm">helm docs</a> if you need to install it.
Make sure that you enable the <a class="reference external" href="https://github.com/helm/charts#how-do-i-enable-the-stable-repository-for-helm-3">stable repository</a></p></li>
</ul>
</div>
<div class="section" id="running-locally">
<h2>Running locally<a class="headerlink" href="#running-locally" title="Permalink to this headline">¶</a></h2>
<p>Running kubernetes locally is a daunting and error prone task.
Fortunately there are ways to make life easier and <a class="reference external" href="https://minikube.sigs.k8s.io/docs/">Minikube</a> makes it a breeze.</p>
<p>We need to give minikube a little bit more resources than default so start minikube like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">minikube start --cpus=6</span>
</pre></div>
</div>
<p>Then make kubectl aware of this local installation like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">eval $(minikube docker-env)</span>
</pre></div>
</div>
</div>
<div class="section" id="deploy-cert-manager">
<h2>Deploy Cert Manager<a class="headerlink" href="#deploy-cert-manager" title="Permalink to this headline">¶</a></h2>
<p>First deploy Cert Manager, you can either follow <a class="reference external" href="https://cert-manager.io/docs/installation/kubernetes/">upsteam instructions</a> or use following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -f examples/common/cert-manager.yaml</span>
</pre></div>
</div>
<p>This will install Cert Manager with self signed certificate.</p>
<p>Once it’s deployed, wait until all Cert Manager pods will enter into Running state:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl wait -n cert-manager --for=condition=ready pod -l app=cert-manager --timeout=60s</span>
</pre></div>
</div>
</div>
<div class="section" id="deploy-scylla-operator">
<h2>Deploy Scylla Operator<a class="headerlink" href="#deploy-scylla-operator" title="Permalink to this headline">¶</a></h2>
<p>Deploy the  Scylla Operator using the following commands:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -f examples/common/operator.yaml</span>
</pre></div>
</div>
<p>This will install the operator StatefulSet in namespace scylla-operator-system.
You can check if the operator is up and running with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla-operator-system get pod</span>
</pre></div>
</div>
<p>If you want to check the logs of the operator you can do so with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla-operator-system logs scylla-operator-controller-manager-0</span>
</pre></div>
</div>
<p>The output should be something like:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">{&quot;L&quot;:&quot;INFO&quot;,&quot;T&quot;:&quot;2020-04-28T08:49:17.065Z&quot;,&quot;M&quot;:&quot;Operator started&quot;,&quot;version&quot;:&quot;0.1.6&quot;,&quot;build_date&quot;:&quot;2020-04-14T12:58:26Z&quot;,&quot;commit&quot;:&quot;416da6008d2165752bfef51ed65145a77c25d3a3&quot;,&quot;built_by&quot;:&quot;goreleaser&quot;,&quot;go_version&quot;:&quot;go version go1.14.2 linux/amd64&quot;,&quot;options&quot;:{&quot;Name&quot;:&quot;scylla-operator-controller-manager-0&quot;,&quot;Namespace&quot;:&quot;scylla-operator-system&quot;,&quot;LogLevel&quot;:&quot;info&quot;,&quot;Image&quot;:&quot;&quot;,&quot;EnableAdmissionWebhook&quot;:true},&quot;_trace_id&quot;:&quot;ZcptKkJHQh6MYQOxLSWXlw&quot;}</span>
<span class="go">{&quot;L&quot;:&quot;INFO&quot;,&quot;T&quot;:&quot;2020-04-28T08:49:17.180Z&quot;,&quot;M&quot;:&quot;Registering Components.&quot;,&quot;_trace_id&quot;:&quot;ZcptKkJHQh6MYQOxLSWXlw&quot;}</span>
<span class="go">{&quot;L&quot;:&quot;INFO&quot;,&quot;T&quot;:&quot;2020-04-28T08:49:17.665Z&quot;,&quot;M&quot;:&quot;Starting the operator...&quot;,&quot;_trace_id&quot;:&quot;ZcptKkJHQh6MYQOxLSWXlw&quot;}</span>
</pre></div>
</div>
</div>
<div class="section" id="create-and-initialize-a-scylla-cluster">
<h2>Create and Initialize a Scylla Cluster<a class="headerlink" href="#create-and-initialize-a-scylla-cluster" title="Permalink to this headline">¶</a></h2>
<p>Now that the operator is running, we can create an instance of a Scylla cluster by creating an instance of the <code class="docutils literal notranslate"><span class="pre">clusters.scylla.scylladb.com</span></code> resource.
Some of that resource’s values are configurable, so feel free to browse <code class="docutils literal notranslate"><span class="pre">cluster.yaml</span></code> and tweak the settings to your liking.
Full details for all the configuration options can be found in the <a class="reference internal" href="scylla_cluster_crd.html"><span class="doc">Scylla Cluster CRD documentation</span></a>.</p>
<p>When you are ready to create a Scylla cluster, simply run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create -f examples/generic/cluster.yaml</span>
</pre></div>
</div>
<p>We can verify that a Kubernetes object has been created that represents our new Scylla cluster with the command below.
This is important because it shows that  has successfully extended Kubernetes to make Scylla clusters a first class citizen in the Kubernetes cloud-native environment.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla get ScyllaCluster</span>
</pre></div>
</div>
<p>Checking the pods that are created is as easy as:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla get pods</span>
</pre></div>
</div>
<p>The output should be something like:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                                    READY   STATUS    RESTARTS   AGE</span>
<span class="go">simple-cluster-us-east-1-us-east-1a-0   2/2     Running   0          9m49s</span>
<span class="go">simple-cluster-us-east-1-us-east-1a-1   2/2     Running   0          7m43s</span>
<span class="go">simple-cluster-us-east-1-us-east-1a-2   2/2     Running   0          6m46s</span>
</pre></div>
</div>
<p>It is important to note that the operator creates these instances according to a pattern.
This pattern is as follows: <code class="docutils literal notranslate"><span class="pre">CLUSTER_NAME-DATACENTER_NAME-RACK_NAME-INSTANCE_NUMBER</span></code> as specified in <code class="docutils literal notranslate"><span class="pre">cluster.yaml</span></code>.</p>
<p>In the above example we have the following properties:</p>
<ul class="simple">
<li><p>CLUSTER_NAME: <code class="docutils literal notranslate"><span class="pre">simple-cluster</span></code></p></li>
<li><p>DATACENTER_NAME: <code class="docutils literal notranslate"><span class="pre">us-east-1</span></code></p></li>
<li><p>RACK_NAME: <code class="docutils literal notranslate"><span class="pre">us-east-1a</span></code></p></li>
<li><p>INSTANCE_NUMBER: An automatically generated number attached to the pod name.</p></li>
</ul>
<p>We picked the names to resemble something you can find in a cloud service but this is inconsequential, they can be set to anything you want.</p>
<p>To check if all the desired members are running, you should see the same number of entries from the following command as the number of members that was specified in <code class="docutils literal notranslate"><span class="pre">cluster.yaml</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla get pod -l app=scylla</span>
</pre></div>
</div>
<p>You can also track the state of a Scylla cluster from its status. To check the current status of a Cluster, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla describe ScyllaCluster simple-cluster</span>
</pre></div>
</div>
<p>Checking the logs of the running scylla instances can be done like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla logs simple-cluster-us-east-1-us-east-1a-0 scylla</span>
</pre></div>
</div>
<div class="section" id="configure-host-networking">
<h3>Configure host networking<a class="headerlink" href="#configure-host-networking" title="Permalink to this headline">¶</a></h3>
<p>To squeeze the most out of your deployment it is sometimes necessary to employ <a class="reference external" href="https://kubernetes.io/docs/concepts/services-networking/">host networking</a>.
To enable this the CRD allows for specifying a <code class="docutils literal notranslate"><span class="pre">network</span></code> parameter as such:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">4.0.0</span>
  <span class="l l-Scalar l-Scalar-Plain">agentVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0.2</span>
  <span class="l l-Scalar l-Scalar-Plain">cpuset</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">network</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">hostNetworking</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>This will result in hosts network to be used for the Scylla Stateful Set deployment.</p>
</div>
<div class="section" id="configure-container-kernel-parameters">
<h3>Configure container kernel parameters<a class="headerlink" href="#configure-container-kernel-parameters" title="Permalink to this headline">¶</a></h3>
<p>Sometimes it is necessary to run the container with different kernel parameters.
In order to support this, the Scylla Operator defines a cluster property <code class="docutils literal notranslate"><span class="pre">sysctls</span></code> that is a list of the desired key-value pairs to set.</p>
<p><em><strong>For example</strong></em>: To increase the number events available for asynchronous IO processing in the Linux kernel to N set sysctls to<code class="docutils literal notranslate"><span class="pre">fs.aio-max-nr=N</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">racks</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rack-name</span>
    <span class="l l-Scalar l-Scalar-Plain">scyllaConfig</span><span class="p p-Indicator">:</span> <span class="s">&quot;scylla-config&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">scyllaAgentConfig</span><span class="p p-Indicator">:</span> <span class="s">&quot;scylla-agent-config&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">sysctls</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;fs.aio-max-nr=2097152&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="deploying-alternator">
<h3>Deploying Alternator<a class="headerlink" href="#deploying-alternator" title="Permalink to this headline">¶</a></h3>
<p>The operator is also capable of deploying <a class="reference external" href="https://www.scylladb.com/alternator/">Alternator</a> instead of the regular Scylla.
This requires a small change in the cluster definition.
Change the <code class="docutils literal notranslate"><span class="pre">cluster.yaml</span></code> file from this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">4.0.0</span>
  <span class="l l-Scalar l-Scalar-Plain">agentVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0.2</span>
  <span class="l l-Scalar l-Scalar-Plain">developerMode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">datacenter</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>
</pre></div>
</div>
<p>to this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">4.0.0</span>
  <span class="l l-Scalar l-Scalar-Plain">alternator</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
    <span class="l l-Scalar l-Scalar-Plain">writeIsolation</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">only_rmw_uses_lwt</span>
  <span class="l l-Scalar l-Scalar-Plain">agentVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0.2</span>
  <span class="l l-Scalar l-Scalar-Plain">developerMode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">datacenter</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>
</pre></div>
</div>
<p>You can specify whichever port you want.</p>
<p>You must provide desired write isolation, supported values are: “always”, “forbid_rmw”, “only_rmw_uses_lwt”.
Difference between those isolation levels can be found in Scylla Alternator documentation.</p>
<p>Once this is done the regular CQL ports will no longer be available, the cluster is a pure Alienator cluster.</p>
</div>
</div>
<div class="section" id="accessing-the-database">
<h2>Accessing the Database<a class="headerlink" href="#accessing-the-database" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>From kubectl:</p></li>
</ul>
<p>To get a cqlsh shell in your new Cluster:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl exec -n scylla -it simple-cluster-us-east-1-us-east-1a-0 -- cqlsh</span>
<span class="gp">&gt;</span> DESCRIBE KEYSPACES<span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>From inside a Pod:</p></li>
</ul>
<p>When you create a new Cluster,  automatically creates a Service for the clients to use in order to access the Cluster.
The service’s name follows the convention <code class="docutils literal notranslate"><span class="pre">&lt;cluster-name&gt;-client</span></code>.
You can see this Service in your cluster by running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla describe service simple-cluster-client</span>
</pre></div>
</div>
<p>Pods running inside the Kubernetes cluster can use this Service to connect to Scylla.
Here’s an example using the <a class="reference external" href="https://github.com/datastax/python-driver">Python Driver</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cassandra.cluster</span> <span class="kn">import</span> <span class="n">Cluster</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">([</span><span class="s1">&#39;simple-cluster-client.scylla.svc&#39;</span><span class="p">])</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</pre></div>
</div>
<p>If you are running the Alternator you can access the API on the port you specified using plain http.</p>
</div>
<div class="section" id="configure-scylla">
<h2>Configure Scylla<a class="headerlink" href="#configure-scylla" title="Permalink to this headline">¶</a></h2>
<p>The operator can take a ConfigMap and apply it to the scylla.yaml configuration file.
This is done by adding a ConfigMap to Kubernetes and refering to this in the Rack specification.
The ConfigMap is just a file called <code class="docutils literal notranslate"><span class="pre">scylla.yaml</span></code> that has the properties you want to change in it.
The operator will take the default properties for the rest of the configuration.</p>
<ul class="simple">
<li><p>Create a ConfigMap the default name that the operator uses is <code class="docutils literal notranslate"><span class="pre">scylla-config</span></code>:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create configmap scylla-config -n scylla --from-file=/path/to/scylla.yaml</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Wait for the mount to propagate and then restart the cluster:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl rollout restart -n scylla statefulset/simple-cluster-us-east-1-us-east-1a</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The new config should be applied automatically by the operator, check the logs to be sure.</p></li>
</ul>
<p>Configuring <code class="docutils literal notranslate"><span class="pre">cassandra-rackdc.properties</span></code> is done by adding the file to the same mount as <code class="docutils literal notranslate"><span class="pre">scylla.yaml</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create configmap scylla-config -n scylla --from-file=/tmp/scylla.yaml --from-file=/tmp/cassandra-rackdc.properties -o yaml --dry-run | kubectl replace -f -</span>
</pre></div>
</div>
<p>The operator will then apply the overridable properties <code class="docutils literal notranslate"><span class="pre">prefer_local</span></code> and <code class="docutils literal notranslate"><span class="pre">dc_suffix</span></code> if they are available in the provided mounted file.</p>
</div>
<div class="section" id="configure-scylla-manager-agent">
<h2>Configure Scylla Manager Agent<a class="headerlink" href="#configure-scylla-manager-agent" title="Permalink to this headline">¶</a></h2>
<p>The operator creates a second container for each scylla instance that runs <a class="reference external" href="https://hub.docker.com/r/scylladb/scylla-manager-agent">Scylla Manager Agent</a>.
This container serves as a sidecar and it’s the main endpoint for <a class="reference external" href="https://hub.docker.com/r/scylladb/scylla-manager">Scylla Manager</a> when interacting with Scylla.
The Scylla Manager Agent can be configured with various things such as the security token used to allow access to it’s API.</p>
<p>To configure the agent you just create a new secret called <em>scylla-agent-config-secret</em> and populate it with the contents in the <code class="docutils literal notranslate"><span class="pre">scylla-manager-agent.yaml</span></code> file like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create secret -n scylla generic scylla-agent-config-secret --from-file scylla-manager-agent.yaml</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://docs.scylladb.com/operating-scylla/manager/2.0/agent-configuration-file/">Scylla Manager Agent configuration</a> for a complete reference of the Scylla Manager agent config file.</p>
<p>In order for the operator to be able to use the agent it may need to be configured accordingly. For example it needs a matching security token.
The operator uses a file called <code class="docutils literal notranslate"><span class="pre">scylla-client.yaml</span></code> for this and the content is today limited to two properties:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">auth_token</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">the_token</span>
</pre></div>
</div>
<p>To configure the operator you just create a new config-map called <em>scylla-client-config-secret</em> and populate it with the contents in the <code class="docutils literal notranslate"><span class="pre">scylla-client.yaml</span></code> file like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create secret -n scylla generic scylla-client-config-secret --from-file scylla-client.yaml</span>
</pre></div>
</div>
<p>After a restart the operator will use the security token when it interacts with scylla via the agent.</p>
<div class="section" id="setting-up-monitoring">
<h3>Setting up Monitoring<a class="headerlink" href="#setting-up-monitoring" title="Permalink to this headline">¶</a></h3>
<p>Both Prometheus and Grafana were configured with specific rules for Scylla Operator.
Both of them will be available under the <code class="docutils literal notranslate"><span class="pre">monitoring</span></code> namespace.
Customization can be done in <code class="docutils literal notranslate"><span class="pre">examples/common/prometheus/values.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">examples/common/grafana/values.yaml</span></code>.</p>
<ol>
<li><p>Create the monitoring namespace</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create namespace monitoring</span>
</pre></div>
</div>
</li>
<li><p>Add Prometheus charts repository</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">helm repo add stable  https://charts.helm.sh/stable</span>
<span class="go">helm repo update</span>
</pre></div>
</div>
</li>
<li><p>Install Prometheus</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">helm upgrade --install scylla-prom --namespace monitoring stable/prometheus -f examples/common/prometheus/values.yaml</span>
</pre></div>
</div>
<p>If you want to tweak the prometheus properties, for example it’s assigned memory, you can override it by adding a command line argument like this: <code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">server.resources.limits.memory=4Gi</span></code></p>
</li>
<li><p>Install Grafana
First you need to prepare the dashboards to make them available in Grafana.
You can do this by running the following command in the <code class="docutils literal notranslate"><span class="pre">examples</span></code> directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./dashboards.sh</span>
</pre></div>
</div>
<p><strong>NB</strong>: Keep in mind that this is a test setup. For production use, check grafana and prometheus helm chart page for advanced deployment instructions.</p>
<p>Now the dashboards can be created along with the grafana plugin like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">helm upgrade --install scylla-graf --namespace monitoring stable/grafana -f examples/common/grafana/values.yaml</span>
</pre></div>
</div>
<p>To access Grafana locally, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl --namespace monitoring port-forward $(kubectl get pods -n monitoring -l &quot;app.kubernetes.io/instance=scylla-graf&quot; -o jsonpath=&quot;{.items[0].metadata.name}&quot;) 3000
</pre></div>
</div>
<p>You can find it on <code class="docutils literal notranslate"><span class="pre">http://0.0.0.0:3000</span></code> and login with the credentials <code class="docutils literal notranslate"><span class="pre">admin</span></code>:<code class="docutils literal notranslate"><span class="pre">admin</span></code>.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="scale-up">
<h2>Scale Up<a class="headerlink" href="#scale-up" title="Permalink to this headline">¶</a></h2>
<p>The operator supports scale up of a rack as well as addition of new racks. To make the changes, you can use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla edit ScyllaCluster simple-cluster</span>
</pre></div>
</div>
<ul class="simple">
<li><p>To scale up a rack, change the <code class="docutils literal notranslate"><span class="pre">Spec.Members</span></code> field of the rack to the desired value.</p></li>
<li><p>To add a new rack, append the <code class="docutils literal notranslate"><span class="pre">racks</span></code> list with a new rack. Remember to choose a different rack name for the new rack.</p></li>
<li><p>After editing and saving the yaml, check your cluster’s Status and Events for information on what’s happening:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla describe ScyllaCluster simple-cluster</span>
</pre></div>
</div>
</div>
<div class="section" id="benchmark-with-cassandra-stress">
<h2>Benchmark with cassandra-stress<a class="headerlink" href="#benchmark-with-cassandra-stress" title="Permalink to this headline">¶</a></h2>
<p>After deploying our cluster along with the monitoring, we can benchmark it using cassandra-stress and see its performance in Grafana. We have a mini cli that generates Kubernetes Jobs that run cassandra-stress against a cluster.</p>
<blockquote>
<div><p>Because cassandra-stress doesn’t scale well to multiple cores, we use multiple jobs with a small core count for each</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run a benchmark with 10 jobs, with 6 cpus and 50.000.000 operations each.</span>
<span class="c1"># Each Job will throttle throughput to 30.000 ops/sec for a total of 300.000 ops/sec.</span>
scripts/cass-stress-gen.py --num-jobs<span class="o">=</span><span class="m">10</span> --cpu<span class="o">=</span><span class="m">6</span> --memory<span class="o">=</span>20G --ops<span class="o">=</span><span class="m">50000000</span> --limit<span class="o">=</span><span class="m">30000</span>
kubectl apply -f scripts/cassandra-stress.yaml
</pre></div>
</div>
<p>Make sure you set the proper arguments in case you have altered things such as <em>name</em> or <em>namespace</em>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./scripts/cass-stress-gen.py -h
usage: cass-stress-gen.py <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--num-jobs NUM_JOBS<span class="o">]</span> <span class="o">[</span>--name NAME<span class="o">]</span> <span class="o">[</span>--namespace NAMESPACE<span class="o">]</span> <span class="o">[</span>--scylla-version SCYLLA_VERSION<span class="o">]</span> <span class="o">[</span>--host HOST<span class="o">]</span> <span class="o">[</span>--cpu CPU<span class="o">]</span> <span class="o">[</span>--memory MEMORY<span class="o">]</span> <span class="o">[</span>--ops OPS<span class="o">]</span> <span class="o">[</span>--threads THREADS<span class="o">]</span> <span class="o">[</span>--limit LIMIT<span class="o">]</span>
                          <span class="o">[</span>--connections-per-host CONNECTIONS_PER_HOST<span class="o">]</span> <span class="o">[</span>--print-to-stdout<span class="o">]</span> <span class="o">[</span>--nodeselector NODESELECTOR<span class="o">]</span>

Generate cassandra-stress job templates <span class="k">for</span> Kubernetes.

optional arguments:
  -h, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>
  --num-jobs NUM_JOBS   number of Kubernetes <span class="nb">jobs</span> to generate - defaults to <span class="m">1</span>
  --name NAME           name of the generated yaml file - defaults to cassandra-stress
  --namespace NAMESPACE
                        namespace of the cassandra-stress <span class="nb">jobs</span> - defaults to <span class="s2">&quot;default&quot;</span>
  --scylla-version SCYLLA_VERSION
                        version of scylla server to use <span class="k">for</span> cassandra-stress - defaults to <span class="m">4</span>.0.0
  --host HOST           ip or dns name of host to connect to - defaults to scylla-cluster-client.scylla.svc
  --cpu CPU             number of cpus that will be used <span class="k">for</span> each job - defaults to <span class="m">1</span>
  --memory MEMORY       memory that will be used <span class="k">for</span> each job in GB, ie 2G - defaults to 2G * cpu
  --ops OPS             number of operations <span class="k">for</span> each job - defaults to <span class="m">10000000</span>
  --threads THREADS     number of threads used <span class="k">for</span> each job - defaults to <span class="m">50</span> * cpu
  --limit LIMIT         rate limit <span class="k">for</span> each job - defaults to no rate-limiting
  --connections-per-host CONNECTIONS_PER_HOST
                        number of connections per host - defaults to number of cpus
  --print-to-stdout     print to stdout instead of writing to a file
  --nodeselector NODESELECTOR
                        nodeselector limits cassandra-stress pods to certain nodes. Use as a label selector, eg. --nodeselector <span class="nv">role</span><span class="o">=</span>scylla
</pre></div>
</div>
<p>While the benchmark is running, open up Grafana and take a look at the monitoring metrics.</p>
<p>After the Jobs finish, clean them up with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl delete -f scripts/cassandra-stress.yaml
</pre></div>
</div>
</div>
<div class="section" id="scale-down">
<h2>Scale Down<a class="headerlink" href="#scale-down" title="Permalink to this headline">¶</a></h2>
<p>The operator supports scale down of a rack. To make the changes, you can use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla edit ScyllaCluster simple-cluster</span>
</pre></div>
</div>
<ul class="simple">
<li><p>To scale down a rack, change the <code class="docutils literal notranslate"><span class="pre">Spec.Members</span></code> field of the rack to the desired value.</p></li>
<li><p>After editing and saving the yaml, check your cluster’s Status and Events for information on what’s happening:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla describe ScyllaCluster simple-cluster</span>
</pre></div>
</div>
</div>
<div class="section" id="clean-up">
<h2>Clean Up<a class="headerlink" href="#clean-up" title="Permalink to this headline">¶</a></h2>
<p>To clean up all resources associated with this walk-through, you can run the commands below.</p>
<p><strong>NOTE:</strong> this will destroy your database and delete all of its associated data.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl delete -f examples/generic/cluster.yaml</span>
<span class="go">kubectl delete -f examples/common/operator.yaml</span>
<span class="go">kubectl delete -f examples/common/cert-manager.yaml</span>
</pre></div>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<p>If the cluster does not come up, the first step would be to examine the operator’s logs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla-operator-system logs -l app=scylla-operator</span>
</pre></div>
</div>
<p>If everything looks OK in the operator logs, you can also look in the logs for one of the Scylla instances:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla logs simple-cluster-us-east-1-us-east-1a-0</span>
</pre></div>
</div>
</div>
</div>

        </div>

        <div id="sidebar" class="large-3 large-pull-6 columns"><div class="side-nav">
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deploying Scylla on a Kubernetes Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="eks.html">Deploying Scylla on EKS (experimental)</a></li>
<li class="toctree-l1"><a class="reference internal" href="gke.html">Deploying Scylla on GKE</a></li>
<li class="toctree-l1"><a class="reference internal" href="manager.html">Deploying Scylla Manager on a Kubernetes Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="node_operations.html">Node operations using Scylla Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">Upgrade of Scylla Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="scylla_cluster_crd.html">Scylla Cluster CRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to Scylla Operator</a></li>
</ul>

</div>
        </div>

        <div class="large-3 columns">
            
                <div class="versions-dropdown ">
    <button class="button">
	v1.0

	 <i class="fa fa-caret-down" aria-hidden="true"></i>
    </button>
    <ul class="content">
            <li><a href="../master/generic.html">master</a></li>
            <li><a href="../v0.3/generic.html">v0.3</a></li>
            <li><a href="generic.html">v1.0</a></li>
    </ul>
</div>
            
        </div>

    </div>
</section>

<!-- newsleter modal -->

<div id="newsletter_signup" class="reveal-modal tiny radius dark_modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <a class="close-reveal-modal" aria-label="Close">×</a>
    <h2 id="modalTitle">Sign up for the Scylla newsletter</h2>
    <div id="mc_embed_signup">
        <form action="//cloudius-systems.us10.list-manage.com/subscribe/post?u=df8bb543c68230d5f7b4dcf78&amp;id=9a4589f144" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
            <div id="mc_embed_signup_scroll">

                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-EMAIL">Email</label></div>
                        <div class="small-9 columns"><input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-FNAME">First Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="FNAME" class="" id="mce-FNAME"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-LNAME">Last Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="LNAME" class="" id="mce-LNAME"></div>
                    </div>
                </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;"><input type="text" name="b_df8bb543c68230d5f7b4dcf78_9a4589f144" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" class="button" value="Sign up" name="subscribe" id="mc-embedded-subscribe"></div>
            </div>
        </form>
    </div>
</div>

<!-- end newsleter modal -->



<!-- footer.html -->
<footer id="footer">
    <div class="footer-top">
        <a class="logo" href="https://www.scylladb.com"><img src="_static/img/logo-scylla-horizontal-RGB.svg" alt=""></a>
        <div class="footer-links">
            <a class="link" href="https://docs.scylladb.com">Docs</a>
            <a class="link" href="https://www.scylladb.com/company/contact-us/">Contact Us</a>
            <a class="link" href="https://www.scylladb.com/company/">About Us</a>
            <a class="link button" href="https://github.com/scylladb/scylla-operator/issues/new?title=Issue in page Deploying Scylla on a Kubernetes Cluster&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://operator.docs.scylladb.com/v1.0/generic%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix" target="_blank">
                Report an issue on this page</a>
        </div>
        <div class="footer-actions">
            <a class="link-icon" href="https://github.com/ScyllaDB" target="_blank">
                <span class="icon-github2"></span></a>
            <a class="link-icon" href="https://twitter.com/ScyllaDB" target="_blank">
                <span class="icon-twitter"></span></a>
            <a class="link-icon" href="https://www.linkedin.com/company/scylladb"  target="_blank">
                <span class="icon-linkedin2"></span></a>
            <a class="link-icon" href="https://www.facebook.com/scylladb/" target="_blank">
                <span class="icon-facebook"></span></a>
        </div>
    </div>

    <div class="footer-bottom">
        <div class="footer-info">
            <div class="footer-copyright">
                &#169; 2021, ScyllaDB. All rights reserved.
            </div>
            <div class="footer-last-updated">
                Last updated on 10 February 2021.
            </div>
            <div class="footer-version">
                Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
                &amp; <a href="https://pypi.org/project/sphinx-scylladb-theme">ScyllaDB Theme 0.1.21</a>
            </div>
        </div>
        <div class="footer-links">
        </div>
    </div>
</footer>
<!-- end footer.html -->

<!-- bodyscripts.html -->
<!-- at the end of the BODY --> 
<script src="_static/js/vendor/jquery.js"></script>
<script src="_static/js/vendor/jquery.cookie.min.js"></script>
<script src="_static/expertrec.js"></script>
<script src="_static/js/foundation/foundation.js"></script>
<script src="_static/js/foundation/foundation.topbar.js"></script>
<script src="_static/app.js"></script>
<script>
    $(document).foundation();
</script>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <!-- end bodyscripts.html -->
</body>
</html>